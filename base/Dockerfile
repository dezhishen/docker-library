ARG BASE_ALPINE_IMAGE=alpine:edge

FROM ${BASE_ALPINE_IMAGE}
ARG TARGETPLATFORM
ARG INSTALL_FFMPEG=false
ARG INSTALL_ARIA2=false
LABEL MAINTAINER="OpenList"

WORKDIR /opt/openlist/
RUN echo "ðŸ” Build args: INSTALL_FFMPEG=$INSTALL_FFMPEG, INSTALL_ARIA2=$INSTALL_ARIA2" && \
    apk update && \
    apk upgrade --no-cache && \
    apk add --no-cache bash ca-certificates su-exec tzdata runit && \
    if [ "$INSTALL_FFMPEG" = "true" ]; then \
        echo "ðŸ“¦ Installing FFmpeg..." && \
        apk add --no-cache ffmpeg; \
    else \
        echo "â­ï¸  Skipping FFmpeg installation"; \
    fi && \
    if [ "$INSTALL_ARIA2" = "true" ]; then \
        echo "ðŸ“¦ Installing Aria2..." && \
        apk add --no-cache curl aria2 && \
        mkdir -p /opt/aria2/.aria2 && \
        curl -fsSL --retry 3 https://codeload.github.com/P3TERX/aria2.conf/tar.gz/refs/heads/master -o /tmp/aria-conf.tar.gz && \
        tar -zxvf /tmp/aria-conf.tar.gz -C /opt/aria2/.aria2 --strip-components=1 && rm -f /tmp/aria-conf.tar.gz && \
        sed -i 's|rpc-secret|#rpc-secret|g' /opt/aria2/.aria2/aria2.conf && \
        sed -i 's|/root/.aria2|/opt/aria2/.aria2|g' /opt/aria2/.aria2/aria2.conf && \
        sed -i 's|/root/.aria2|/opt/aria2/.aria2|g' /opt/aria2/.aria2/script.conf && \
        sed -i 's|/root|/opt/aria2|g' /opt/aria2/.aria2/aria2.conf && \
        sed -i 's|/root|/opt/aria2|g' /opt/aria2/.aria2/script.conf && \
        mkdir -p /opt/service/stop/aria2/log && \
        echo '#!/bin/sh' > /opt/service/stop/aria2/run && \
        echo 'exec 2>&1' >> /opt/service/stop/aria2/run && \
        echo 'exec aria2c --enable-rpc --rpc-allow-origin-all --conf-path=/opt/aria2/.aria2/aria2.conf' >> /opt/service/stop/aria2/run && \
        echo '#!/bin/sh' > /opt/service/stop/aria2/log/run && \
        echo 'mkdir -p /opt/openlist/data/log/aria2 2>/dev/null' >> /opt/service/stop/aria2/log/run && \
        echo 'exec svlogd /opt/openlist/data/log/aria2' >> /opt/service/stop/aria2/log/run && \
        chmod +x /opt/service/stop/aria2/run /opt/service/stop/aria2/log/run && \
        touch /opt/aria2/.aria2/aria2.session && \
        (cd /opt/aria2/.aria2 && ./tracker.sh && echo "âœ… Tracker update completed successfully" || echo "âš ï¸  Tracker update failed, continuing..."); \
    else \
        echo "â­ï¸  Skipping Aria2 installation"; \
    fi && \
    rm -rf /var/cache/apk/*

RUN mkdir -p /opt/service/start && chmod 777 /opt/service/start && \ 
    mkdir -p /opt/service/stop/openlist && \
    echo '#!/bin/sh' > /opt/service/stop/openlist/run && \
    echo 'exec 2>&1' >> /opt/service/stop/openlist/run && \
    echo 'cd /opt/openlist' >> /opt/service/stop/openlist/run && \
    echo 'exec ./openlist server --no-prefix' >> /opt/service/stop/openlist/run && \
    chmod +x /opt/service/stop/openlist/run

